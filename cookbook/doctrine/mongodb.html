

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to use MongoDB &mdash; Symfony2Docs v0 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Symfony2Docs v0 documentation" href="../../index.html" />
    <link rel="up" title="Cookbook" href="../index.html" />
    <link rel="next" title="How to use Doctrine Migrations" href="migrations.html" />
    <link rel="prev" title="How to create Fixtures in Symfony2" href="doctrine_fixtures.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="migrations.html" title="How to use Doctrine Migrations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="doctrine_fixtures.html" title="How to create Fixtures in Symfony2"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Symfony2Docs v0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Cookbook</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-use-mongodb">
<span id="index-0"></span><h1>How to use MongoDB<a class="headerlink" href="#how-to-use-mongodb" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="http://www.mongodb.org/">MongoDB</a> Object Document Mapper (ODM) is much like the Doctrine2 ORM
in its philosophy and how it works. In other words, like the <a class="reference internal" href="../../book/doctrine.html"><em>Doctrine2 ORM</em></a>,
with the Doctrine ODM, you deal only with plain PHP objects, which are then
persisted transparently to and from MongoDB.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can read more about the Doctrine MongoDB ODM via the project&#8217;s <a class="reference external" href="http://www.doctrine-project.org/docs/mongodb_odm/1.0/en">documentation</a>.</p>
</div>
<p>A bundle is available that integrates the Doctrine MongoDB ODM into Symfony,
making it easy to configure and use.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This chapter will feel a lot like the <a class="reference internal" href="../../book/doctrine.html"><em>Doctrine2 ORM chapter</em></a>,
which talks about how the Doctrine ORM can be used to persist data to
relational databases (e.g. MySQL). This is on purpose - whether you persist
to a relational database via the ORM or MongoDB via the ODM, the philosophies
are very much the same.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>To use the MongoDB ODM, you&#8217;ll need two libraries provided by Doctrine and
one bundle that integrates them into Symfony. If you&#8217;re using the Symfony
Standard Distribution, add the following to the <tt class="docutils literal"><span class="pre">deps</span></tt> file at the root
of your project:</p>
<div class="highlight-text"><div class="highlight"><pre>[doctrine-mongodb]
    git=http://github.com/doctrine/mongodb.git

[doctrine-mongodb-odm]
    git=http://github.com/doctrine/mongodb-odm.git

[DoctrineMongoDBBundle]
    git=http://github.com/symfony/DoctrineMongoDBBundle.git
    target=/bundles/Symfony/Bundle/DoctrineMongoDBBundle
</pre></div>
</div>
<p>Now, update the vendor libraries by running:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php bin/vendors install
</pre></div>
</div>
<p>Next, add the <tt class="docutils literal"><span class="pre">Doctrine\ODM\MongoDB</span></tt> and <tt class="docutils literal"><span class="pre">Doctrine\MongoDB</span></tt> namespaces
to the <tt class="docutils literal"><span class="pre">app/autoload.php</span></tt> file so that these libraries can be autoloaded.
Be sure to add them anywhere <em>above</em> the <tt class="docutils literal"><span class="pre">Doctrine</span></tt> namespace (shown here):</p>
<div class="highlight-python"><pre>// app/autoload.php
$loader-&gt;registerNamespaces(array(
    // ...
    'Doctrine\\ODM\\MongoDB'    =&gt; __DIR__.'/../vendor/doctrine-mongodb-odm/lib',
    'Doctrine\\MongoDB'         =&gt; __DIR__.'/../vendor/doctrine-mongodb/lib',
    'Doctrine'                  =&gt; __DIR__.'/../vendor/doctrine/lib',
    // ...
));</pre>
</div>
<p>Next, register the annotations library by adding the following to the autoloader
(below the existing <tt class="docutils literal"><span class="pre">AnnotationRegistry::registerFile</span></tt> line):</p>
<div class="highlight-python"><pre>// app/autoload.php
AnnotationRegistry::registerFile(
    __DIR__.'/../vendor/doctrine-mongodb-odm/lib/Doctrine/ODM/MongoDB/Mapping/Annotations/DoctrineAnnotations.php'
);</pre>
</div>
<p>Finally, enable the new bundle in the kernel:</p>
<div class="highlight-python"><pre>// app/AppKernel.php
public function registerBundles()
{
    $bundles = array(
        // ...
        new Symfony\Bundle\DoctrineMongoDBBundle\DoctrineMongoDBBundle(),
    );

    // ...
}</pre>
</div>
<p>Congratulations! You&#8217;re ready to get to work.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>To get started, you&#8217;ll need some basic configuration that sets up the document
manager. The easiest way is to enable <tt class="docutils literal"><span class="pre">auto_mapping</span></tt>, which will activate
the MongoDB ODM across your application:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">doctrine_mongodb</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">connections</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mongodb://localhost:27017</span>
            <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">connect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">default_database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test_database</span>
    <span class="l-Scalar-Plain">document_managers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">auto_mapping</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course, you&#8217;ll also need to make sure that the MongoDB server is running
in the background. For more details, see the MongoDB <a class="reference external" href="http://www.mongodb.org/display/DOCS/Quickstart">Quick Start</a> guide.</p>
</div>
</div>
<div class="section" id="a-simple-example-a-product">
<h2>A Simple Example: A Product<a class="headerlink" href="#a-simple-example-a-product" title="Permalink to this headline">¶</a></h2>
<p>The best way to understand the Doctrine MongoDB ODM is to see it in action.
In this section, you&#8217;ll walk through each step needed to start persisting
documents to and from MongoDB.</p>
<div class="sidebar">
<p class="first sidebar-title">Code along with the example</p>
<p>If you want to follow along with the example in this chapter, create
an <tt class="docutils literal"><span class="pre">AcmeStoreBundle</span></tt> via:</p>
<div class="last highlight-bash"><div class="highlight"><pre>php app/console generate:bundle --namespace<span class="o">=</span>Acme/StoreBundle
</pre></div>
</div>
</div>
<div class="section" id="creating-a-document-class">
<h3>Creating a Document Class<a class="headerlink" href="#creating-a-document-class" title="Permalink to this headline">¶</a></h3>
<p>Suppose you&#8217;re building an application where products need to be displayed.
Without even thinking about Doctrine or MongoDB, you already know that you
need a <tt class="docutils literal"><span class="pre">Product</span></tt> object to represent those products. Create this class
inside the <tt class="docutils literal"><span class="pre">Document</span></tt> directory of your <tt class="docutils literal"><span class="pre">AcmeStoreBundle</span></tt>:</p>
<div class="highlight-python"><pre>// src/Acme/StoreBundle/Document/Product.php
namespace Acme\StoreBundle\Document;

class Product
{
    protected $name;

    protected $price;
}</pre>
</div>
<p>The class - often called a &#8220;document&#8221;, meaning <em>a basic class that holds data</em> -
is simple and helps fulfill the business requirement of needing products
in your application. This class can&#8217;t be persisted to Doctrine MongoDB yet -
it&#8217;s just a simple PHP class.</p>
</div>
<div class="section" id="add-mapping-information">
<h3>Add Mapping Information<a class="headerlink" href="#add-mapping-information" title="Permalink to this headline">¶</a></h3>
<p>Doctrine allows you to work with MongoDB in a much more interesting way
than just fetching data back and forth as an array. Instead, Doctrine allows
you to persist entire <em>objects</em> to MongoDB and fetch entire objects out of
MongoDB. This works by mapping a PHP class and its properties to entries
of a MongoDB collection.</p>
<p>For Doctrine to be able to do this, you just have to create &#8220;metadata&#8221;, or
configuration that tells Doctrine exactly how the <tt class="docutils literal"><span class="pre">Product</span></tt> class and its
properties should be <em>mapped</em> to MongoDB. This metadata can be specified
in a number of different formats including YAML, XML or directly inside the
<tt class="docutils literal"><span class="pre">Product</span></tt> class via annotations:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Annotations</em><div class="highlight-php-annotations"><pre>// src/Acme/StoreBundle/Document/Product.php
namespace Acme\StoreBundle\Document;

use Doctrine\ODM\MongoDB\Mapping\Annotations as MongoDB;

/**
 * @MongoDB\Document
 */
class Product
{
    /**
     * @MongoDB\Id
     */
    protected $id;

    /**
     * @MongoDB\String
     */
    protected $name;

    /**
     * @MongoDB\Float
     */
    protected $price;
}</pre>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/StoreBundle/Resources/config/doctrine/Product.mongodb.yml</span>
<span class="l-Scalar-Plain">Acme\StoreBundle\Document\Product</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">true</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
        <span class="l-Scalar-Plain">price</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">float</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/StoreBundle/Resources/config/doctrine/Product.mongodb.xml --&gt;</span>
<span class="nt">&lt;doctrine-mongo-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/odm/doctrine-mongo-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/odm/doctrine-mongo-mapping</span>
<span class="s">                    http://doctrine-project.org/schemas/odm/doctrine-mongo-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;document</span> <span class="na">name=</span><span class="s">&quot;Acme\StoreBundle\Document\Product&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">fieldName=</span><span class="s">&quot;id&quot;</span> <span class="na">id=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">fieldName=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">fieldName=</span><span class="s">&quot;price&quot;</span> <span class="na">type=</span><span class="s">&quot;float&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/document&gt;</span>
<span class="nt">&lt;/doctrine-mongo-mapping&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Doctrine allows you to choose from a wide variety of different field types,
each with their own options. For information on the available field types,
see the <a class="reference internal" href="#cookbook-mongodb-field-types"><em>Doctrine Field Types Reference</em></a> section.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">You can also check out Doctrine&#8217;s <a class="reference external" href="http://www.doctrine-project.org/docs/mongodb_odm/1.0/en/reference/basic-mapping.html">Basic Mapping Documentation</a> for
all details about mapping information. If you use annotations, you&#8217;ll
need to prepend all annotations with <tt class="docutils literal"><span class="pre">MongoDB\</span></tt> (e.g. <tt class="docutils literal"><span class="pre">MongoDB\String</span></tt>),
which is not shown in Doctrine&#8217;s documentation. You&#8217;ll also need to include
the <tt class="docutils literal"><span class="pre">use</span> <span class="pre">Doctrine\ODM\MongoDB\Mapping\Annotations</span> <span class="pre">as</span> <span class="pre">MongoDB;</span></tt> statement,
which <em>imports</em> the <tt class="docutils literal"><span class="pre">MongoDB</span></tt> annotations prefix.</p>
</div>
</div>
<div class="section" id="generating-getters-and-setters">
<h3>Generating Getters and Setters<a class="headerlink" href="#generating-getters-and-setters" title="Permalink to this headline">¶</a></h3>
<p>Even though Doctrine now knows how to persist a <tt class="docutils literal"><span class="pre">Product</span></tt> object to MongoDB
the class itself isn&#8217;t really useful yet. Since <tt class="docutils literal"><span class="pre">Product</span></tt> is just a regular
PHP class, you need to create getter and setter methods (e.g. <tt class="docutils literal"><span class="pre">getName()</span></tt>,
<tt class="docutils literal"><span class="pre">setName()</span></tt>) in order to access its properties (since the properties are
<tt class="docutils literal"><span class="pre">protected</span></tt>). Fortunately, Doctrine can do this for you by running:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:mongodb:generate:documents AcmeStoreBundle
</pre></div>
</div>
<p>This command makes sure that all of the getters and setters are generated
for the <tt class="docutils literal"><span class="pre">Product</span></tt> class. This is a safe command - you can run it over and
over again: it only generates getters and setters that don&#8217;t exist (i.e. it
doesn&#8217;t replace your existing methods).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Doctrine doesn&#8217;t care whether your properties are <tt class="docutils literal"><span class="pre">protected</span></tt> or <tt class="docutils literal"><span class="pre">private</span></tt>,
or whether or not you have a getter or setter function for a property.
The getters and setters are generated here only because you&#8217;ll need them
to interact with your PHP object.</p>
</div>
</div>
<div class="section" id="persisting-objects-to-mongodb">
<h3>Persisting Objects to MongoDB<a class="headerlink" href="#persisting-objects-to-mongodb" title="Permalink to this headline">¶</a></h3>
<p>Now that you have a mapped <tt class="docutils literal"><span class="pre">Product</span></tt> document complete with getter and
setter methods, you&#8217;re ready to persist data to MongoDB. From inside a controller,
this is pretty easy. Add the following method to the <tt class="docutils literal"><span class="pre">DefaultController</span></tt>
of the bundle:</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="x">// src/Acme/StoreBundle/Controller/DefaultController.php</span>
<span class="x">use Acme\StoreBundle\Document\Product;</span>
<span class="x">use Symfony\Component\HttpFoundation\Response;</span>
<span class="x">// ...</span>

<span class="x">public function createAction()</span>
<span class="x">{</span>
<span class="x">    $product = new Product();</span>
<span class="x">    $product-&gt;setName(&#39;A Foo Bar&#39;);</span>
<span class="x">    $product-&gt;setPrice(&#39;19.99&#39;);</span>

<span class="x">    $dm = $this-&gt;get(&#39;doctrine.odm.mongodb.document_manager&#39;);</span>
<span class="x">    $dm-&gt;persist($product);</span>
<span class="x">    $dm-&gt;flush();</span>

<span class="x">    return new Response(&#39;Created product id &#39;.$product-&gt;getId());</span>
<span class="x">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;re following along with this example, you&#8217;ll need to create a
route that points to this action to see it in work.</p>
</div>
<p>Let&#8217;s walk through this example:</p>
<ul class="simple">
<li><strong>lines 8-10</strong> In this section, you instantiate and work with the <tt class="docutils literal"><span class="pre">$product</span></tt>
object like any other, normal PHP object;</li>
<li><strong>line 12</strong> This line fetches Doctrine&#8217;s <em>document manager</em> object, which is
responsible for handling the process of persisting and fetching objects
to and from MongoDB;</li>
<li><strong>line 13</strong> The <tt class="docutils literal"><span class="pre">persist()</span></tt> method tells Doctrine to &#8220;manage&#8221; the <tt class="docutils literal"><span class="pre">$product</span></tt>
object. This does not actually cause a query to be made to MongoDB (yet).</li>
<li><strong>line 14</strong> When the <tt class="docutils literal"><span class="pre">flush()</span></tt> method is called, Doctrine looks through
all of the objects that it&#8217;s managing to see if they need to be persisted
to MongoDB. In this example, the <tt class="docutils literal"><span class="pre">$product</span></tt> object has not been persisted yet,
so the document manager makes a query to MongoDB, which adds a new entry.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In fact, since Doctrine is aware of all your managed objects, when you
call the <tt class="docutils literal"><span class="pre">flush()</span></tt> method, it calculates an overall changeset and executes
the most efficient operation possible.</p>
</div>
<p>When creating or updating objects, the workflow is always the same. In the
next section, you&#8217;ll see how Doctrine is smart enough to update entries if
they already exist in MongoDB.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Doctrine provides a library that allows you to programmatically load testing
data into your project (i.e. &#8220;fixture data&#8221;). For information, see
<a class="reference internal" href="doctrine_fixtures.html"><em>How to create Fixtures in Symfony2</em></a>.</p>
</div>
</div>
<div class="section" id="fetching-objects-from-mongodb">
<h3>Fetching Objects from MongoDB<a class="headerlink" href="#fetching-objects-from-mongodb" title="Permalink to this headline">¶</a></h3>
<p>Fetching an object back out of MongoDB is even easier. For example, suppose
you&#8217;ve configured a route to display a specific <tt class="docutils literal"><span class="pre">Product</span></tt> based on its
<tt class="docutils literal"><span class="pre">id</span></tt> value:</p>
<div class="highlight-python"><pre>public function showAction($id)
{
    $product = $this-&gt;get('doctrine.odm.mongodb.document_manager')
        -&gt;getRepository('AcmeStoreBundle:Product')
        -&gt;find($id);

    if (!$product) {
        throw $this-&gt;createNotFoundException('No product found for id '.$id);
    }

    // do something, like pass the $product object into a template
}</pre>
</div>
<p>When you query for a particular type of object, you always use what&#8217;s known
as its &#8220;repository&#8221;. You can think of a repository as a PHP class whose only
job is to help you fetch objects of a certain class. You can access the
repository object for a document class via:</p>
<div class="highlight-python"><pre>$repository = $this-&gt;get('doctrine.odm.mongodb.document_manager')
    -&gt;getRepository('AcmeStoreBundle:Product');</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">AcmeStoreBundle:Product</span></tt> string is a shortcut you can use anywhere
in Doctrine instead of the full class name of the document (i.e. <tt class="docutils literal"><span class="pre">Acme\StoreBundle\Document\Product</span></tt>).
As long as your document lives under the <tt class="docutils literal"><span class="pre">Document</span></tt> namespace of your bundle,
this will work.</p>
</div>
<p>Once you have your repository, you have access to all sorts of helpful methods:</p>
<div class="highlight-python"><pre>// query by the primary key (usually "id")
$product = $repository-&gt;find($id);

// dynamic method names to find based on a column value
$product = $repository-&gt;findOneById($id);
$product = $repository-&gt;findOneByName('foo');

// find *all* products
$products = $repository-&gt;findAll();

// find a group of products based on an abitrary column value
$products = $repository-&gt;findByPrice(19.99);</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course, you can also issue complex queries, which you&#8217;ll learn more
about in the <a class="reference internal" href="../../book/doctrine.html#book-doctrine-queries"><em>Querying for Objects</em></a> section.</p>
</div>
<p>You can also take advantage of the useful <tt class="docutils literal"><span class="pre">findBy</span></tt> and <tt class="docutils literal"><span class="pre">findOneBy</span></tt> methods
to easily fetch objects based on multiple conditions:</p>
<div class="highlight-python"><pre>// query for one product matching be name and price
$product = $repository-&gt;findOneBy(array('name' =&gt; 'foo', 'price' =&gt; 19.99));

// query for all prdocuts matching the name, ordered by price
$product = $repository-&gt;findBy(
    array('name' =&gt; 'foo'),
    array('price', 'ASC')
);</pre>
</div>
</div>
<div class="section" id="updating-an-object">
<h3>Updating an Object<a class="headerlink" href="#updating-an-object" title="Permalink to this headline">¶</a></h3>
<p>Once you&#8217;ve fetched an object from Doctrine, updating it is easy. Suppose
you have a route that maps a product id to an update action in a controller:</p>
<div class="highlight-python"><pre>public function updateAction($id)
{
    $dm = $this-&gt;get('doctrine.odm.mongodb.document_manager');
    $product = $dm-&gt;getRepository('AcmeStoreBundle:Product')-&gt;find($id);

    if (!$product) {
        throw $this-&gt;createNotFoundException('No product found for id '.$id);
    }

    $product-&gt;setName('New product name!');
    $dm-&gt;flush();

    return $this-&gt;redirect($this-&gt;generateUrl('homepage'));
}</pre>
</div>
<p>Updating an object involves just three steps:</p>
<ol class="arabic simple">
<li>fetching the object from Doctrine;</li>
<li>modifying the object;</li>
<li>calling <tt class="docutils literal"><span class="pre">flush()</span></tt> on the document manager</li>
</ol>
<p>Notice that calling <tt class="docutils literal"><span class="pre">$dm-&gt;persist($product)</span></tt> isn&#8217;t necessary. Recall that
this method simply tells Doctrine to manage or &#8220;watch&#8221; the <tt class="docutils literal"><span class="pre">$product</span></tt> object.
In this case, since you fetched the <tt class="docutils literal"><span class="pre">$product</span></tt> object from Doctrine, it&#8217;s
already managed.</p>
</div>
<div class="section" id="deleting-an-object">
<h3>Deleting an Object<a class="headerlink" href="#deleting-an-object" title="Permalink to this headline">¶</a></h3>
<p>Deleting an object is very similar, but requires a call to the <tt class="docutils literal"><span class="pre">remove()</span></tt>
method of the document manager:</p>
<div class="highlight-python"><pre>$dm-&gt;remove($product);
$dm-&gt;flush();</pre>
</div>
<p>As you might expect, the <tt class="docutils literal"><span class="pre">remove()</span></tt> method notifies Doctrine that you&#8217;d
like to remove the given document from the MongoDB. The actual delete operation
however, isn&#8217;t actually executed until the <tt class="docutils literal"><span class="pre">flush()</span></tt> method is called.</p>
</div>
</div>
<div class="section" id="querying-for-objects">
<h2>Querying for Objects<a class="headerlink" href="#querying-for-objects" title="Permalink to this headline">¶</a></h2>
<p>As you saw above, the built-in repository class allows you to query for one
or many objects based on an number of different parameters. When this is
enough, this is the easiest way to query for documents. Of course, you can
also create more complex queries.</p>
<div class="section" id="using-the-query-builder">
<h3>Using the Query Builder<a class="headerlink" href="#using-the-query-builder" title="Permalink to this headline">¶</a></h3>
<p>Doctrine&#8217;s ODM ships with a query &#8220;Builder&#8221; object, which allows you to construct
a query for exactly which documents you want to return. If you use an IDE,
you can also take advantage of auto-completion as you type the method names.
From inside a controller:</p>
<div class="highlight-python"><pre>$products = $this-&gt;get('doctrine.odm.mongodb.document_manager')
    -&gt;createQueryBuilder('AcmeStoreBundle:Product')
    -&gt;field('name')-&gt;equals('foo')
    -&gt;limit(10)
    -&gt;sort('price', 'ASC')
    -&gt;getQuery()
    -&gt;execute()</pre>
</div>
<p>In this case, 10 products with a name of &#8220;foo&#8221;, ordered from lowest price
to highest price are returned.</p>
<p>The <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> object contains every method necessary to build your
query. For more information on Doctrine&#8217;s Query Builder, consult Doctrine&#8217;s
<a class="reference external" href="http://www.doctrine-project.org/docs/mongodb_odm/1.0/en/reference/query-builder-api.html">Query Builder</a> documentation. For a list of the available conditions you
can place on the query, see the <a class="reference external" href="http://www.doctrine-project.org/docs/mongodb_odm/1.0/en/reference/query-builder-api.html#conditional-operators">Conditional Operators</a> documentation specifically.</p>
</div>
<div class="section" id="custom-repository-classes">
<h3>Custom Repository Classes<a class="headerlink" href="#custom-repository-classes" title="Permalink to this headline">¶</a></h3>
<p>In the previous section, you began constructing and using more complex queries
from inside a controller. In order to isolate, test and reuse these queries,
it&#8217;s a good idea to create a custom repository class for your document and
add methods with your query logic there.</p>
<p>To do this, add the name of the repository class to your mapping definition.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Annotations</em><div class="highlight-php-annotations"><pre>// src/Acme/StoreBundle/Document/Product.php
namespace Acme\StoreBundle\Document;

use Doctrine\ODM\MongoDB\Mapping\Annotations as MongoDB;

/**
 * @MongoDB\Document(repositoryClass="Acme\StoreBundle\Repository\ProductRepository")
 */
class Product
{
    //...
}</pre>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/StoreBundle/Resources/config/doctrine/Product.mongodb.yml</span>
<span class="l-Scalar-Plain">Acme\StoreBundle\Document\Product</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">repositoryClass</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Acme\StoreBundle\Repository\ProductRepository</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/StoreBundle/Resources/config/doctrine/Product.mongodb.xml --&gt;</span>
<span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;doctrine-mongo-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/odm/doctrine-mongo-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/odm/doctrine-mongo-mapping</span>
<span class="s">                    http://doctrine-project.org/schemas/odm/doctrine-mongo-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;document</span> <span class="na">name=</span><span class="s">&quot;Acme\StoreBundle\Document\Product&quot;</span>
            <span class="na">repository-class=</span><span class="s">&quot;Acme\StoreBundle\Repository\ProductRepository&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;/document&gt;</span>

<span class="nt">&lt;/doctrine-mong-mapping&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Doctrine can generate the repository class for you by running :</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:mongodb:generate:repositories AcmeStoreBundle
</pre></div>
</div>
<p>Next, add a new method - <tt class="docutils literal"><span class="pre">findAllOrderedByName()</span></tt> - to the newly generated
repository class. This method will query for all of the <tt class="docutils literal"><span class="pre">Product</span></tt> documents,
ordered alphabetically.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// src/Acme/StoreBundle/Repository/ProductRepository.php</span>
<span class="x">namespace Acme\StoreBundle\Repository;</span>

<span class="x">use Doctrine\ODM\MongoDB\DocumentRepository;</span>

<span class="x">class ProductRepository extends DocumentRepository</span>
<span class="x">{</span>
<span class="x">    public function findAllOrderedByName()</span>
<span class="x">    {</span>
<span class="x">        return $this-&gt;createQueryBuilder()</span>
<span class="x">            -&gt;sort(&#39;name&#39;, &#39;ASC&#39;)</span>
<span class="x">            -&gt;getQuery()</span>
<span class="x">            -&gt;execute();</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>You can use this new method just like the default finder methods of the repository:</p>
<div class="highlight-python"><pre>$product = $this-&gt;get('doctrine.odm.mongodb.document_manager')
    -&gt;getRepository('AcmeStoreBundle:Product')
    -&gt;findAllOrderedByName();</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using a custom repository class, you still have access to the default
finder methods such as <tt class="docutils literal"><span class="pre">find()</span></tt> and <tt class="docutils literal"><span class="pre">findAll()</span></tt>.</p>
</div>
</div>
</div>
<div class="section" id="doctrine-extensions-timestampable-sluggable-etc">
<h2>Doctrine Extensions: Timestampable, Sluggable, etc.<a class="headerlink" href="#doctrine-extensions-timestampable-sluggable-etc" title="Permalink to this headline">¶</a></h2>
<p>Doctrine is quite flexible, and a number of third-party extensions are available
that allow you to easily perform repeated and common tasks on your entities.
These include thing such as <em>Sluggable</em>, <em>Timestampable</em>, <em>Loggable</em>, <em>Translatable</em>,
and <em>Tree</em>.</p>
<p>For more information on how to find and use these extensions, see the cookbook
article about <a class="reference internal" href="common_extensions.html"><em>using common Doctrine extensions</em></a>.</p>
</div>
<div class="section" id="doctrine-field-types-reference">
<span id="cookbook-mongodb-field-types"></span><h2>Doctrine Field Types Reference<a class="headerlink" href="#doctrine-field-types-reference" title="Permalink to this headline">¶</a></h2>
<p>Doctrine comes with a large number of field types available. Each of these
maps a PHP data type to a specific <a class="reference external" href="http://us.php.net/manual/en/mongo.types.php">MongoDB type</a>. The following are just <em>some</em>
of the types supported by Doctrine:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">string</span></tt></li>
<li><tt class="docutils literal"><span class="pre">int</span></tt></li>
<li><tt class="docutils literal"><span class="pre">float</span></tt></li>
<li><tt class="docutils literal"><span class="pre">date</span></tt></li>
<li><tt class="docutils literal"><span class="pre">timestamp</span></tt></li>
<li><tt class="docutils literal"><span class="pre">boolean</span></tt></li>
<li><tt class="docutils literal"><span class="pre">file</span></tt></li>
</ul>
<p>For more information, see Doctrine&#8217;s <a class="reference external" href="http://www.doctrine-project.org/docs/mongodb_odm/1.0/en/reference/basic-mapping.html#doctrine-mapping-types">Mapping Types documentation</a>.</p>
</div>
<div class="section" id="console-commands">
<span id="index-1"></span><h2>Console Commands<a class="headerlink" href="#console-commands" title="Permalink to this headline">¶</a></h2>
<p>The Doctrine2 ODM integration offers several console commands under the
<tt class="docutils literal"><span class="pre">doctrine:mongodb</span></tt> namespace. To view the command list you can run the console
without any arguments:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console
</pre></div>
</div>
<p>A list of available command will print out, many of which start with the
<tt class="docutils literal"><span class="pre">doctrine:mongodb</span></tt> prefix. You can find out more information about any
of these commands (or any Symfony command) by running the <tt class="docutils literal"><span class="pre">help</span></tt> command.
For example, to get details about the <tt class="docutils literal"><span class="pre">doctrine:mongodb:query</span></tt> task, run:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console <span class="nb">help </span>doctrine:mongodb:query
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To be able to load data fixtures into MongoDB, you will need to have the
<tt class="docutils literal"><span class="pre">DoctrineFixturesBundle</span></tt> bundle installed. To learn how to do it,
read the &#8220;<a class="reference internal" href="doctrine_fixtures.html"><em>How to create Fixtures in Symfony2</em></a>&#8221; entry of the Cookbook.</p>
</div>
</div>
<div class="section" id="index-2">
<span id="id1"></span><h2>Configuration<a class="headerlink" href="#index-2" title="Permalink to this headline">¶</a></h2>
<p>For detailed information on configuration options available when using the
Doctrine ODM, see the <a class="reference internal" href="../../reference/configuration/mongodb.html"><em>MongoDB Reference</em></a> section.</p>
<div class="section" id="registering-event-listeners-and-subscribers">
<h3>Registering Event Listeners and Subscribers<a class="headerlink" href="#registering-event-listeners-and-subscribers" title="Permalink to this headline">¶</a></h3>
<p>Doctrine allows you to register listeners and subscribers that are notified
when different events occur inside Doctrine&#8217;s ODM. For more information,
see Doctrine&#8217;s <a class="reference external" href="http://www.doctrine-project.org/docs/mongodb_odm/1.0/en/reference/events.html">Event Documentation</a>.</p>
<p>In Symfony, you can register a listener or subscriber by creating a <a class="reference internal" href="../../glossary.html#term-service"><em class="xref std std-term">service</em></a>
and then <a class="reference internal" href="../../book/service_container.html#book-service-container-tags"><em>tagging</em></a> it with a specific tag.</p>
<ul>
<li><p class="first"><strong>event listener</strong>: Use the <tt class="docutils literal"><span class="pre">doctrine.odm.mongodb.&lt;connection&gt;_event_listener</span></tt>
tag, where <tt class="docutils literal"><span class="pre">&lt;connection&gt;</span></tt> name is replaced by the name of your connection
(usually <tt class="docutils literal"><span class="pre">default</span></tt>). Also, be sure to add an <tt class="docutils literal"><span class="pre">event</span></tt> key to the tag
specifying which event to listen to. Assuming your connection is called
<tt class="docutils literal"><span class="pre">default</span></tt>, then:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">my_doctrine_listener</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">Acme\HelloBundle\Listener\MyDoctrineListener</span>
        <span class="c1"># ...</span>
        <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span>  <span class="p-Indicator">{</span> <span class="nv">name</span><span class="p-Indicator">:</span> <span class="nv">doctrine.odm.mongodb.default_event_listener</span><span class="p-Indicator">,</span> <span class="nv">event</span><span class="p-Indicator">:</span> <span class="nv">postPersist</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;my_doctrine_listener&quot;</span> <span class="na">class=</span><span class="s">&quot;Acme\HelloBundle\Listener\MyDoctrineListener&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;doctrine.odm.mongodb.default_event_listener&quot;</span> <span class="na">event=</span><span class="s">&quot;postPersist&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/service&gt;</span>.
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="x">$definition = new Definition(&#39;Acme\HelloBundle\Listener\MyDoctrineListener&#39;);</span>
<span class="x">// ...</span>
<span class="x">$definition-&gt;addTag(&#39;doctrine.odm.mongodb.default_event_listener&#39;);</span>
<span class="x">$container-&gt;setDefinition(&#39;my_doctrine_listener&#39;, $definition);</span>
</pre></div>
</div>
</li>
</ul>
</div>
</li>
<li><p class="first"><strong>event subscriber</strong>: Use the <tt class="docutils literal"><span class="pre">doctrine.odm.mongodb.&lt;connection&gt;_event_subscriber</span></tt>
tag. No other keys are needed in the tag.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>With Doctrine, you can focus on your objects and how they&#8217;re useful in your
application and worry about persisting to MongoDB second. This is because
Doctrine allows you to use any PHP object to hold your data and relies on
mapping metadata information to map an object&#8217;s data to a MongoDB collection.</p>
<p>And even though Doctrine revolves around a simple concept, it&#8217;s incredibly
powerful, allowing you to create complex queries and subscribe to events
that allow you to take different actions as objects go through their persistence
lifecycle.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to use MongoDB</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#a-simple-example-a-product">A Simple Example: A Product</a><ul>
<li><a class="reference internal" href="#creating-a-document-class">Creating a Document Class</a></li>
<li><a class="reference internal" href="#add-mapping-information">Add Mapping Information</a></li>
<li><a class="reference internal" href="#generating-getters-and-setters">Generating Getters and Setters</a></li>
<li><a class="reference internal" href="#persisting-objects-to-mongodb">Persisting Objects to MongoDB</a></li>
<li><a class="reference internal" href="#fetching-objects-from-mongodb">Fetching Objects from MongoDB</a></li>
<li><a class="reference internal" href="#updating-an-object">Updating an Object</a></li>
<li><a class="reference internal" href="#deleting-an-object">Deleting an Object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querying-for-objects">Querying for Objects</a><ul>
<li><a class="reference internal" href="#using-the-query-builder">Using the Query Builder</a></li>
<li><a class="reference internal" href="#custom-repository-classes">Custom Repository Classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#doctrine-extensions-timestampable-sluggable-etc">Doctrine Extensions: Timestampable, Sluggable, etc.</a></li>
<li><a class="reference internal" href="#doctrine-field-types-reference">Doctrine Field Types Reference</a></li>
<li><a class="reference internal" href="#console-commands">Console Commands</a></li>
<li><a class="reference internal" href="#index-2">Configuration</a><ul>
<li><a class="reference internal" href="#registering-event-listeners-and-subscribers">Registering Event Listeners and Subscribers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="doctrine_fixtures.html"
                        title="previous chapter">How to create Fixtures in Symfony2</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="migrations.html"
                        title="next chapter">How to use Doctrine Migrations</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/cookbook/doctrine/mongodb.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="migrations.html" title="How to use Doctrine Migrations"
             >next</a> |</li>
        <li class="right" >
          <a href="doctrine_fixtures.html" title="How to create Fixtures in Symfony2"
             >previous</a> |</li>
        <li><a href="../../index.html">Symfony2Docs v0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Cookbook</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Rafael Goulart.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>