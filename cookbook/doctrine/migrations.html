

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to use Doctrine Migrations &mdash; Symfony2Docs v0 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Symfony2Docs v0 documentation" href="../../index.html" />
    <link rel="up" title="Cookbook" href="../index.html" />
    <link rel="next" title="How to handle File Uploads with Doctrine" href="file_uploads.html" />
    <link rel="prev" title="How to use MongoDB" href="mongodb.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="file_uploads.html" title="How to handle File Uploads with Doctrine"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mongodb.html" title="How to use MongoDB"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Symfony2Docs v0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Cookbook</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-use-doctrine-migrations">
<span id="index-0"></span><h1>How to use Doctrine Migrations<a class="headerlink" href="#how-to-use-doctrine-migrations" title="Permalink to this headline">¶</a></h1>
<p>The database migrations feature is an extension of the database abstraction
layer and offers you the ability to programmatically deploy new versions of
your database schema in a safe, easy and standardized way.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can read more about the Doctrine Database Migrations on the project&#8217;s
<a class="reference external" href="http://www.doctrine-project.org/projects/migrations/2.0/docs/reference/introduction/en">documentation</a>.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Doctrine migrations for Symfony are maintained in the <a class="reference external" href="https://github.com/symfony/DoctrineMigrationsBundle">DoctrineMigrationsBundle</a>.
Make sure you have both the <tt class="docutils literal"><span class="pre">doctrine-migrations</span></tt> and <tt class="docutils literal"><span class="pre">DoctrineMigrationsBundle</span></tt>
libraries configured in your project. Follow these steps to install the
libraries in the Symfony Standard distribution.</p>
<p>Add the following to <tt class="docutils literal"><span class="pre">deps</span></tt>. This will register the Migrations Bundle
and the doctrine-migrations library as dependencies in your application:</p>
<div class="highlight-text"><div class="highlight"><pre>[doctrine-migrations]
    git=http://github.com/doctrine/migrations.git

[DoctrineMigrationsBundle]
    git=http://github.com/symfony/DoctrineMigrationsBundle.git
    target=/bundles/Symfony/Bundle/DoctrineMigrationsBundle
</pre></div>
</div>
<p>Update the vendor libraries:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php bin/vendors install
</pre></div>
</div>
<p>Next, ensure the new <tt class="docutils literal"><span class="pre">Doctrine\DBAL\Migrations</span></tt> namespace will be autoloaded
via <tt class="docutils literal"><span class="pre">autoload.php</span></tt>. The new <tt class="docutils literal"><span class="pre">Migrations</span></tt> namespace <em>must</em> be placed above
the <tt class="docutils literal"><span class="pre">Doctrine\\DBAL</span></tt> entry so that the autoloader looks inside the migrations
directory for those classes:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// app/autoload.php</span>
<span class="x">$loader-&gt;registerNamespaces(array(</span>
<span class="x">    //...</span>
<span class="x">    &#39;Doctrine\\DBAL\\Migrations&#39; =&gt; __DIR__.&#39;/../vendor/doctrine-migrations/lib&#39;,</span>
<span class="x">    &#39;Doctrine\\DBAL&#39;             =&gt; __DIR__.&#39;/../vendor/doctrine-dbal/lib&#39;,</span>
<span class="x">));</span>
</pre></div>
</div>
<p>Finally, be sure to enable the bundle in <tt class="docutils literal"><span class="pre">AppKernel.php</span></tt> by including the
following:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">// app/AppKernel.php</span>
<span class="x">public function registerBundles()</span>
<span class="x">{</span>
<span class="x">    $bundles = array(</span>
<span class="x">        //...</span>
<span class="x">        new Symfony\Bundle\DoctrineMigrationsBundle\DoctrineMigrationsBundle(),</span>
<span class="x">    );</span>
<span class="x">}</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>All of the migrations functionality is contained in a few console commands:</p>
<div class="highlight-bash"><div class="highlight"><pre>doctrine:migrations
  :diff     Generate a migration by comparing your current database to your mapping information.
  :execute  Execute a single migration version up or down manually.
  :generate Generate a blank migration class.
  :migrate  Execute a migration to a specified version or the latest available version.
  :status   View the status of a <span class="nb">set </span>of migrations.
  :version  Manually add and delete migration versions from the version table.
</pre></div>
</div>
<p>Start by getting the status of migrations in your application by running
the <tt class="docutils literal"><span class="pre">status</span></tt> command:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:status

 <span class="o">==</span> Configuration

    &gt;&gt; Name:                                               Application Migrations
    &gt;&gt; Configuration Source:                               manually configured
    &gt;&gt; Version Table Name:                                 migration_versions
    &gt;&gt; Migrations Namespace:                               Application<span class="se">\M</span>igrations
    &gt;&gt; Migrations Directory:                               /path/to/project/app/DoctrineMigrations
    &gt;&gt; Current Version:                                    0
    &gt;&gt; Latest Version:                                     0
    &gt;&gt; Executed Migrations:                                0
    &gt;&gt; Available Migrations:                               0
    &gt;&gt; New Migrations:                                     0
</pre></div>
</div>
<p>Now, you can start working with migrations by generating a new blank migration
class. Later, you&#8217;ll learn how Doctrine can generate migrations automatically
for you.</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:generate
Generated new migration class to <span class="s2">&quot;/path/to/project/app/DoctrineMigrations/Version20100621140655.php&quot;</span>
</pre></div>
</div>
<p>Have a look at the newly generated migration class and you will see something
like the following:</p>
<div class="highlight-python"><pre>namespace Application\Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration,
    Doctrine\DBAL\Schema\Schema;

class Version20100621140655 extends AbstractMigration
{
    public function up(Schema $schema)
    {

    }

    public function down(Schema $schema)
    {

    }
}</pre>
</div>
<p>If you run the <tt class="docutils literal"><span class="pre">status</span></tt> command it will now show that you have one new
migration to execute:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:status

 <span class="o">==</span> Configuration

   &gt;&gt; Name:                                               Application Migrations
   &gt;&gt; Configuration Source:                               manually configured
   &gt;&gt; Version Table Name:                                 migration_versions
   &gt;&gt; Migrations Namespace:                               Application<span class="se">\M</span>igrations
   &gt;&gt; Migrations Directory:                               /path/to/project/app/DoctrineMigrations
   &gt;&gt; Current Version:                                    0
   &gt;&gt; Latest Version:                                     2010-06-21 14:06:55 <span class="o">(</span>20100621140655<span class="o">)</span>
   &gt;&gt; Executed Migrations:                                0
   &gt;&gt; Available Migrations:                               1
   &gt;&gt; New Migrations:                                     <span class="nv">1</span>

<span class="o">==</span> Migration Versions

   &gt;&gt; 2010-06-21 14:06:55 <span class="o">(</span>20100621140655<span class="o">)</span>                not migrated
</pre></div>
</div>
<p>Now you can add some migration code to the <tt class="docutils literal"><span class="pre">up()</span></tt> and <tt class="docutils literal"><span class="pre">down()</span></tt> methods and
finally migrate when you&#8217;re ready:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:migrate
</pre></div>
</div>
<p>For more information on how to write the migrations themselves (i.e. how to
fill in the <tt class="docutils literal"><span class="pre">up()</span></tt> and <tt class="docutils literal"><span class="pre">down()</span></tt> methods), see the official Doctrine Migrations
<a class="reference external" href="http://www.doctrine-project.org/projects/migrations/2.0/docs/reference/introduction/en">documentation</a>.</p>
<div class="section" id="running-migrations-during-deployment">
<h3>Running Migrations during Deployment<a class="headerlink" href="#running-migrations-during-deployment" title="Permalink to this headline">¶</a></h3>
<p>Of course, the end goal of writing migrations is to be able to use them to
reliably update your database structure when you deploy your application.
By running the migrations locally (or on a beta server), you can ensure that
the migrations work as you expect.</p>
<p>When you do finally deploy your application, you just need to remember to run
the <tt class="docutils literal"><span class="pre">doctrine:migrations:migrate</span></tt> command. Internally, Doctrine creates
a <tt class="docutils literal"><span class="pre">migration_versions</span></tt> table inside your database and tracks which migrations
have been executed there. So, no matter how many migrations you&#8217;ve created
and executed locally, when you run the command during deployment, Doctrine
will know exactly which migrations it hasn&#8217;t run yet by looking at the <tt class="docutils literal"><span class="pre">migration_versions</span></tt>
table of your production database. Regardless of what server you&#8217;re on, you
can always safely run this command to execute only the migrations that haven&#8217;t
been run yet on <em>that</em> particular database.</p>
</div>
</div>
<div class="section" id="generating-migrations-automatically">
<h2>Generating Migrations Automatically<a class="headerlink" href="#generating-migrations-automatically" title="Permalink to this headline">¶</a></h2>
<p>In reality, you should rarely need to write migrations manually, as the migrations
library can generate migration classes automatically by comparing your Doctrine
mapping information (i.e. what your database <em>should</em> look like) with your
actual current database structure.</p>
<p>For example, suppose you create a new <tt class="docutils literal"><span class="pre">User</span></tt> entity and add mapping information
for Doctrine&#8217;s ORM:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Annotations</em><div class="highlight-php-annotations"><pre>// src/Acme/HelloBundle/Entity/User.php
namespace Acme\HelloBundle\Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 * @ORM\Table(name="hello_user")
 */
class User
{
    /**
     * @ORM\Id
     * @ORM\Column(type="integer")
     * @ORM\GeneratedValue(strategy="AUTO")
     */
    protected $id;

    /**
     * @ORM\Column(type="string", length="255")
     */
    protected $name;
}</pre>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/HelloBundle/Resources/config/doctrine/User.orm.yml</span>
<span class="l-Scalar-Plain">Acme\HelloBundle\Entity\User</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
    <span class="l-Scalar-Plain">table</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello_user</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">integer</span>
            <span class="l-Scalar-Plain">generator</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">strategy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AUTO</span>
    <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
            <span class="l-Scalar-Plain">length</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">255</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- src/Acme/HelloBundle/Resources/config/doctrine/User.orm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://doctrine-project.org/schemas/orm/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Acme\HelloBundle\Entity\User&quot;</span> <span class="na">table=</span><span class="s">&quot;hello_user&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">length=</span><span class="s">&quot;255&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>

<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>With this information, Doctrine is now ready to help you persist your new
<tt class="docutils literal"><span class="pre">User</span></tt> object to and from the <tt class="docutils literal"><span class="pre">hello_user</span></tt> table. Of course, this table
doesn&#8217;t exist yet! Generate a new migration for this table automatically by
running the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:diff
</pre></div>
</div>
<p>You should see a message that a new migration class was generated based on
the schema differences. If you open this file, you&#8217;ll find that it has the
SQL code needed to create the <tt class="docutils literal"><span class="pre">hello_user</span></tt> table. Next, run the migration
to add the table to your database:</p>
<div class="highlight-bash"><div class="highlight"><pre>php app/console doctrine:migrations:migrate
</pre></div>
</div>
<p>The moral of the story is this: after each change you make to your Doctrine
mapping information, run the <tt class="docutils literal"><span class="pre">doctrine:migrations:diff</span></tt> command to automatically
generate your migration classes.</p>
<p>If you do this from the very beginning of your project (i.e. so that even
the first tables were loaded via a migration class), you&#8217;ll always be able
to create a fresh database and run your migrations in order to get your database
schema fully up to date. In fact, this is an easy and dependable workflow
for your project.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to use Doctrine Migrations</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#running-migrations-during-deployment">Running Migrations during Deployment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generating-migrations-automatically">Generating Migrations Automatically</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mongodb.html"
                        title="previous chapter">How to use MongoDB</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="file_uploads.html"
                        title="next chapter">How to handle File Uploads with Doctrine</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/cookbook/doctrine/migrations.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="file_uploads.html" title="How to handle File Uploads with Doctrine"
             >next</a> |</li>
        <li class="right" >
          <a href="mongodb.html" title="How to use MongoDB"
             >previous</a> |</li>
        <li><a href="../../index.html">Symfony2Docs v0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Cookbook</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Rafael Goulart.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>